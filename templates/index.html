<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='index-qr.css') }}" rel="stylesheet" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .message {
            margin-top: 20px;
        }
    </style>
    <script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>
    <script src="{{ url_for('static', filename='qrcode.js') }}"></script>
</head>
<body class="text-center">
    <div class="container mt-5">
        <!-- Ù„ÙˆÚ¯Ùˆ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¨Ù‡ ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
        <a href="{{ url_for('settings') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Ù„ÙˆÚ¯Ùˆ" class="mb-2" style="width: 100px;">
        </a>
        <!-- Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ -->
        <h1 class="mb-4">Ø¨Ø§ Ù†ÛŒÚ©Ùˆ Ù‡Ù… Ù…Ø³ÛŒØ± Ø´ÙˆÛŒØ¯...</h1>
        <p class="instruction">Ù„Ø·ÙØ§ Ú©Ø¯ Ø±Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø³Ú©Ù† ÙØ±Ù…Ø§ÛŒÛŒØ¯.</p>
        <!-- ÙØ±Ù… Ø¨Ø±Ø§ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ -->
        <form action="/scan" method="POST" class="mb-4">
            <div class="mb-3">
                <label for="code" class="form-label">Ú©Ø¯</label>
                <input type="text" id="barcodeInput" class="form-control" id="code" name="code"
                     placeholder="Ú©Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                     pattern="\d{10,}" maxlength="25" inputmode="numeric" required>
            </div>
            <button type="submit" class="btn btn-primary">Ø«Ø¨Øª Ú©Ø¯</button>
            <button type="button" class="btn btn-success" id="btnScan">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                  <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 
                    .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 
                    .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 
                    .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"></path>
                  <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"></path>
                  <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"></path>
                  <path d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 
                    2h-1v1h-2v1h3zm-4 2v-1H8v1z"></path>
                  <path d="M12 9h2V8h-2z"></path>
                </svg>
                Ø¨Ø§Ø±Ú©Ø¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯
              </button>
              <button id="html5-qrcode-button-camera-permission" class="html5-qrcode-element" type="button">Request Camera Permissions</button>
        
       
        <!-- Ø¯Ú©Ù…Ù‡ Ø§Ø³Ú©Ù† -->
<button id="scan-button" class="btn btn-success">
    ğŸ“· Ø§Ø³Ú©Ù† Ú©Ù†
  </button>
  
  <!-- Ø¬Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Ú©Ù†Ø± -->
  <div id="qr-reader" style="width: 300px; display: none;"></div>
  
  <!-- ÙÛŒÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø±Ú©Ø¯ -->
  <input type="text" id="code" placeholder="Ù†ØªÛŒØ¬Ù‡ Ø§Ø³Ú©Ù†" class="form-control mt-2">
</form>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Ø¨Ø³ØªÙ†"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const scanButton = document.getElementById("scan-button");
        const qrReaderElement = document.getElementById("qr-reader");
        let html5QrCode;
      
        scanButton.addEventListener("click", async () => {
          try {
            // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ù…ÛŒÚ˜Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            await navigator.mediaDevices.getUserMedia({ video: true });
      
            // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯ÙˆØ±Ø¨ÛŒÙ†â€ŒÙ‡Ø§
            const devices = await Html5Qrcode.getCameras();
            if (devices && devices.length) {
              // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¹Ù‚Ø¨
              const backCamera = devices.find(device => device.label.toLowerCase().includes("back")) || devices[devices.length - 1];
              const cameraId = backCamera.id;
      
              // Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Ú©Ù†Ø±
              qrReaderElement.style.display = "block";
              html5QrCode = new Html5Qrcode("qr-reader");
      
              const config = { fps: 10, qrbox: 250 };
      
              html5QrCode.start(
                { deviceId: { exact: cameraId } },
                config,
                (decodedText, decodedResult) => {
                  // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± ØªÚ©Ø³Øª Ø¨Ø§Ú©Ø³
                  document.getElementById("code").value = decodedText;
      
                  // ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†
                  html5QrCode.stop().then(() => {
                    qrReaderElement.style.display = "none";
                    html5QrCode.clear();
                  });
                },
                (errorMessage) => {
                  // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù„Ø§Ú¯ Ø¨Ø²Ø§Ø±ÛŒ ÛŒØ§ Ù¾ÛŒØ§Ù… Ù†Ø´ÙˆÙ† Ø¨Ø¯ÛŒ
                  console.warn("Ø®Ø·Ø§ÛŒ Ø§Ø³Ú©Ù†:", errorMessage);
                }
              );
            } else {
              alert("Ø¯ÙˆØ±Ø¨ÛŒÙ†ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
            }
          } catch (err) {
            alert(err);
            alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.");
            console.error(err);
          }
        });
      </script>
</body>
</html>