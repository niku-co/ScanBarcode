<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø§Ø±Ú©Ø¯ Ø§Ø³Ú©Ù†Ø± Ù†ÛŒÚ©Ùˆ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ ZXing Ø§Ø² ÙØ§ÛŒÙ„ Ù…Ø­Ù„ÛŒ (Ù‚Ø±Ø§Ø± Ø¨Ø¯ÛŒØ¯ Ø¯Ø± static) -->
  <script defer src="{{ url_for('static', filename='zxing.min.js') }}"></script>

  <style>
    body { direction: rtl; font-family: 'Segoe UI', Tahoma, sans-serif; }
    #readerContainer { width: 320px; margin: 0 auto; }
    #video-preview {
      width: 320px; height: 240px;
      border-radius: 8px;
      background: #000;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }
    #message { text-align:center; margin-top:10px; font-weight:600; }
    .modal-dialog { max-width: 380px; }
  </style>
</head>
<body class="text-center">

  <div class="container mt-4">
    <a href="{{ url_for('settings') }}">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Ù„ÙˆÚ¯Ùˆ" style="width:100px;" />
    </a>

    <h1 class="h4 mt-2">Ø¨Ø§ Ù†ÛŒÚ©Ùˆ Ù‡Ù… Ù…Ø³ÛŒØ± Ø´ÙˆÛŒØ¯...</h1>
    <p>Ù„Ø·ÙØ§ Ú©Ø¯ Ø±Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø³Ú©Ù† ÙØ±Ù…Ø§ÛŒÛŒØ¯.</p>

    <form action="/scan" method="POST" class="mb-3">
      <div class="mb-3">
        <label for="dynamicCode" class="form-label">Ú©Ø¯</label>
        <input type="text" id="dynamicCode" name="code" class="form-control text-center" placeholder="Ú©Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" pattern="\d{6,}" maxlength="50" required>
      </div>

      <button type="submit" class="btn btn-primary">Ø«Ø¨Øª Ú©Ø¯</button>
      <button type="button" id="openScannerBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#scannerModal">
        Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯
      </button>
    </form>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header">
          <h5 class="modal-title" id="scannerModalLabel">Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
        </div>
        <div class="modal-body">
          <div id="readerContainer">
            <!-- ÙˆÛŒØ¯Ø¦Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ -->
            <video id="video-preview" autoplay playsinline muted></video>
          </div>
          <div id="message" class="mt-2 text-muted">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Â«Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // resilient loader: Ø§Ú¯Ø± window.ZXing Ù‡Ù†ÙˆØ² Ù†Ø¨Ø§Ø´Ù‡ØŒ Ø§Ø² CDN UMD Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  async function ensureZXing() {
    if (window.ZXing) return true;
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js';
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
      return !!window.ZXing;
    } catch (e) {
      console.error('ZXing load failed', e);
      return false;
    }
  }
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const openScannerBtn = document.getElementById('openScannerBtn');
    const videoEl = document.getElementById('video-preview');
    const msgEl = document.getElementById('message');
    const modalEl = document.getElementById('scannerModal');

    let codeReader = null;
    let isScanning = false;

    // ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ø´Ø¯ØŒ Ø§Ø³Ú©Ù†Ø± Ø±Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    modalEl.addEventListener('shown.bs.modal', async () => {
      msgEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...';
      // Ù„ÙˆØ¯ ZXing (Ù„ÙˆÚ©Ø§Ù„ ÛŒØ§ CDN Ùallback)
      const ok = await ensureZXing();
      if (!ok) {
        msgEl.textContent = 'Ø®Ø·Ø§: Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ZXing Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯.';
        return;
      }

      try {
        // Ù†Ù…ÙˆÙ†Ù‡ Ø³Ø§Ø²Ù†Ø¯Ù‡
        codeReader = new ZXing.BrowserMultiFormatReader();

        // ÙÙ‡Ø±Ø³Øª Ø¯ÙˆØ±Ø¨ÛŒÙ†â€ŒÙ‡Ø§
        const devices = await codeReader.listVideoInputDevices();
        // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª Ø¨Ø§ Ø¨Ø±Ú†Ø³Ø¨
        const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];

        if (!back) {
          msgEl.textContent = 'Ø¯ÙˆØ±Ø¨ÛŒÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
          return;
        }

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² decodeFromConstraints Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø±Ø²ÙˆÙ„ÙˆØ´Ù† Ùˆ ÙÛŒÚ©Ø³ Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª
        const constraints = {
          video: {
            deviceId: back.deviceId ? { exact: back.deviceId } : undefined,
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: "environment"
          }
        };

        isScanning = true;
        msgEl.textContent = 'ğŸ“· Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³Ú©Ù†...';
        // Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†
        await codeReader.decodeFromConstraints(constraints, videoEl, (result, err) => {
          if (result) {
            // Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ â€” Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¯Ø± input Ù…ÛŒâ€ŒØ±ÛŒØ²ÛŒÙ… Ùˆ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ù…ÛŒâ€ŒØ¨Ù†Ø¯ÛŒÙ…
            document.getElementById('dynamicCode').value = result.text;
            msgEl.textContent = 'âœ… Ú©Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯!';
            // Ú©ÙˆÚ†Ú© ØªØ§Ø®ÛŒØ±ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø³ØªÙ† (Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù)
            setTimeout(async () => {
              try { await stopScanner(); } catch(_) {}
              const bootstrapModal = bootstrap.Modal.getInstance(modalEl);
              if (bootstrapModal) bootstrapModal.hide();
            }, 300);
          }
          // Ø§Ú¯Ø± Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±ÛŒÙ… Ø¨ÙˆØ¯ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
        });

      } catch (e) {
        console.error(e);
        msgEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†: ' + (e.message || e);
        isScanning = false;
      }
    });

    // ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯ØŒ Ø§Ø³Ú©Ù†Ø± Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†
    modalEl.addEventListener('hidden.bs.modal', async () => {
      await stopScanner();
    });

    async function stopScanner() {
      if (codeReader) {
        try { await codeReader.reset(); } catch(_) {}
      }
      isScanning = false;
      msgEl.textContent = '';
      // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ Ù…Ù†Ø¨Ø¹ (Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†)
      try {
        if (videoEl && videoEl.srcObject) {
          const tracks = videoEl.srcObject.getTracks();
          tracks.forEach(t => t.stop());
          videoEl.srcObject = null;
        }
      } catch (_) {}
    }
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
