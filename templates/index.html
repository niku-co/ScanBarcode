<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحه اصلی</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .message {
            margin-top: 20px;
        }
}
    </style>
    
</head>
<body class="text-center">
    <div class="container mt-5">
        <!-- لوگو با لینک به صفحه تنظیمات -->
        <a href="{{ url_for('settings') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="لوگو" class="mb-2" style="width: 100px;">
        </a>
        <!-- عنوان و دستورالعمل -->
        <h1 class="mb-4">با نیکو هم مسیر شوید...</h1>
        <p class="instruction">لطفا کد را با استفاده از دوربین دستگاه اسکن فرمایید.</p>
        <!-- فرم برای وارد کردن کد -->
        <form action="/scan" method="POST" class="mb-4">
            <div class="mb-3">
                <label for="code" class="form-label">کد</label>
                <input type="text" id="dynamicCode" class="form-control" name="code"
                     placeholder="کد را اینجا وارد کنید"
                     pattern="\d{10,}" maxlength="25" inputmode="numeric" required>
            </div>
            <button type="submit" class="btn btn-primary">ثبت کد</button>
            <button type="button" class="btn btn-success" id="scan-button" onclick="showTab('scanner')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                  <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 
                    .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 
                    .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 
                    .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"></path>
                  <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"></path>
                  <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"></path>
                  <path d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 
                    2h-1v1h-2v1h3zm-4 2v-1H8v1z"></path>
                  <path d="M12 9h2V8h-2z"></path>
                </svg>
                بارکد خود را اسکن کنید
              </button>
            
              <div class="tab-container">
      <button class="tab-button active" onclick="showTab('scanner')">
        Scan Barcode
      </button>
      <button class="tab-button" onclick="showTab('manual')">
        Manual Input
      </button>
    </div>

    <div id="scanner-tab" class="tab-panel">
      <div class="scanner-container">
        <div id="reader"></div>
      </div>
    </div>

    <div id="manual-tab" class="tab-panel hidden">
      <div class="form-container">
        <input
          type="text"
          id="dynamicCode"
          class="input-field"
          placeholder="Enter 10-digit code"
          autocomplete="off"
         
        />
        <button class="submit-button" onclick="handleManualSubmit()">
          Generate
        </button>
      </div>
    </div>

    <div class="result-container">
      <h3>Result:</h3>
      <p id="result">No code processed yet</p>
    </div>

    <div id="message"></div>
        </div>
              <!--<button id="html5-qrcode-button-camera-permission" class="html5-qrcode-element" type="button">Request Camera Permissions</button>-->
  
  <!-- فیلد برای نمایش بارکد 
  <input type="text" id="code" placeholder="نتیجه اسکن" class="form-control mt-2">-->
</form>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="بستن"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='qrcode.js') }}"></script>
    <script>
      // Global variables
      let html5QrCode;
      let activeTab = "scanner";
      const CODE_LENGTH = 10;

      // Function to show notifications
      function showSnack(text, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className =
          type === "error" ? "error-message" : "success-message";

        // Clear the message after 3 seconds
        setTimeout(() => {
          messageEl.textContent = "";
          messageEl.className = "";
        }, 3000);
      }

      // Function to generate password from scanned data
      // This is the exact implementation from your TypeScript code
      function generatePassword(code) {
        if (code.length !== CODE_LENGTH) {
          showSnack("Dynamic code is incorrect. Must be 10 digits.", "error");
          return;
        }

        try {
          const subStringCode = code.substring(0, CODE_LENGTH);

          const list = subStringCode.split("");
          const newCode = (list[4] + list[9]).toUpperCase();
          const asciiBytes = Array.from(newCode).map((char) =>
            char.charCodeAt(0)
          );

          let dynamicPass = "";

          asciiBytes.forEach((byte) => {
            const intValue = byte.toString().padStart(2, "0");
            dynamicPass += intValue;
          });

          return dynamicPass;
        } catch (error) {
          showSnack("Dynamic code is incorrect.", "error");
        }
      }

      // Function to update the result
      function updateResult(code, password) {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `
                <strong>Code:</strong> ${code}<br>
                <strong>Generated Password:</strong> ${password}
            `;
        showSnack("Password generated successfully!", "success");
      }

      // Function to handle manual form submission
      function handleManualSubmit() {
        const codeInput = document.getElementById("dynamicCode");
        const code = codeInput.value.trim();

        if (!code) {
          showSnack("Please enter a code", "error");
          return;
        }

        const password = generatePassword(code);
        if (password) {
          updateResult(code, password);
          codeInput.value = ""; // Clear input after successful submission
        }
      }

      // Function to switch between tabs
      function showTab(tabName) {
        // Update active tab
        activeTab = tabName;

        // Update tab button styles
        document.querySelectorAll(".tab-button").forEach((button) => {
          button.classList.remove("active");
        });
        document
          .querySelector(`.tab-button[onclick="showTab('${tabName}')"]`)
          .classList.add("active");

        // Show/hide tab panels
        document
          .getElementById("scanner-tab")
          .classList.toggle("hidden", tabName !== "scanner");
        document
          .getElementById("manual-tab")
          .classList.toggle("hidden", tabName !== "manual");

        // Handle scanner initialization/stopping
        if (tabName === "scanner") {
          initScanner();
        } else if (html5QrCode && html5QrCode.isScanning) {
          html5QrCode
            .stop()
            .catch((err) => console.error("Error stopping scanner:", err));
        }

        // Focus on input field when manual tab is selected
        if (tabName === "manual") {
          setTimeout(() => document.getElementById("dynamicCode").focus(), 100);
        }
      }

      // Initialize scanner
      function initScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
          return; // Scanner already running
        }

        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Start scanning
        html5QrCode
          .start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
              // On successful scan
              const password = generatePassword(decodedText);
              if (password) {
                updateResult(decodedText, password);
              }
            },
            (errorMessage) => {
              // Errors will be ignored in continuous scanning mode
              // Only show critical errors
              if (errorMessage.includes("Unable to start scanning")) {
                showSnack(errorMessage, "error");
              }
            }
          )
          .catch((err) => {
            showSnack("Error starting scanner: " + err, "error");
          });
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", () => {
        // Start with scanner tab active
        showTab("scanner");

        // Add event listener for Enter key in the input field
        document
          .getElementById("dynamicCode")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              handleManualSubmit();
            }
          });
      });
    </script>
</body>
</html>
